# Cross Site Request Forgery (CSRF)

- Some other site is making request to your site pretending to be another user.

- Cross-site request forgery, or CSRF/XSRF, is an attack that relies on the user's privileges by hijacking their session. This strategy allows an attacker to circumvent our security by essentially deceiving the user into submitting a malicious request on behalf of the attacker.

- CORS does not prevent people from submitting forms from other URLs and CSRF/XSRF attack is happens by submitting form from some other site pretending to be the original site.

- Simplest ways to prevent this is through the use of CSRF tokens, which are unique values dynamically generated by a server-side application and sent to the client. Since these values are unique for every request, and constantly changing, it is nearly impossible for an attacker to pre-create the URLs/requests for an attack.

<br />

### Attack Example:

- This code can be execute from any site.
- Newer version of chrome restricts some level of CSRF attacks.

```jsx
<h1> Bad Guy site Pretending to be Good Site </h1>
<form action="http://localhost:3000/transfer-money" method="POST">
   <input name="amount" type="hidden" value="99999">
   <input name="to" type="hidden" value="Bad Guy">
   <button> Click to Transfer Money </button>
</form>
```

<br />

### Attack Prevention: (using csurf npm package)

1. import the csurf package

```jsx
const csrfProtection = require("csurf")({ cookie: { httpOnly: true } });
```

2. use this variable as middleware in all routes or specific routes

```jsx
app.get('/', csrfProtection, (req, res) => {}
app.post('/transfer-money', csrfProtection, (req, res) => {}

<form action="http://localhost:3000/transfer-money" method="POST">
   <input name="amount" type="hidden" value="99999">
   <input name="to" type="hidden" value="Bad Guy">
   <input type="hidden" name="_csrf" value="${req.csrfToken()}">
   <button> Click to Transfer Money </button>
</form>
```

3. catching the error

```jsx
app.use((err, req, res, next) => {
  if (err.code !== "EBADCSRFTOKEN") return next(err);
  res.status(403);
  res.send("CSRF attack detected");
});
```
